<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>ModClusterDesign</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body id="design" class="article toc2 toc-left">
<div id="header">
<h1>ModClusterDesign</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_next_generation_web_tier_load_balancing_design">Next Generation Web Tier Load Balancing Design</a></li>
<li><a href="#_key_design_goals">Key Design Goals</a></li>
<li><a href="#_basic_architecture">Basic Architecture</a></li>
<li><a href="#_modes">Modes</a>
<ul class="sectlevel2">
<li><a href="#_non_clustered_as_instances">"Non-Clustered" AS instances</a></li>
<li><a href="#_clustered_as_instances">"Clustered" AS instances</a></li>
<li><a href="#_normal_request_handling">Normal Request Handling</a></li>
</ul>
</li>
<li><a href="#_as_zo_mod_cluster_communications_modcluster_managment_protocol_mcmp">AS zo mod_cluster Communications – ModCluster Managment Protocol (MCMP)</a>
<ul class="sectlevel2">
<li><a href="#_basic_categories_of_messages">Basic categories of messages:</a></li>
<li><a href="#_management_message_types">Management Message Types</a></li>
<li><a href="#_virtual_hosts">Virtual Hosts</a></li>
</ul>
</li>
<li><a href="#_modclusterservice_design">ModClusterService Design</a></li>
<li><a href="#_clustering_issues">Clustering Issues</a>
<ul class="sectlevel2">
<li><a href="#_domains">Domains</a></li>
<li><a href="#_split_brain_syndrome">Split-Brain Syndrome</a></li>
</ul>
</li>
<li><a href="#_use_cases">Use cases</a></li>
<li><a href="#_misc">Misc</a></li>
<li><a href="#_other_considerations">Other Considerations</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_next_generation_web_tier_load_balancing_design">Next Generation Web Tier Load Balancing Design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Design document for the next generation JBoss AS web tier load balancing
architecture.</p>
</div>
<div class="paragraph">
<p>See <a href="http://www.jboss.com/index.html?module=bb&amp;op=viewtopic&amp;t=126109">here</a> for
the discussion forum related to this document.</p>
</div>
<div class="paragraph">
<p>See also the following wiki pages:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="ping_pong.html">ModCluster_ping_pong</a></p>
</li>
<li>
<p><a href="node_conf.html">ModCluster_node_conf</a></p>
</li>
<li>
<p><a href="reverse_extension.html">ModCluster_ReverseExtension</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Implementation details:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="management_protocol.html">ModCluster_Management_Protocol</a></p>
</li>
<li>
<p><a href="internals.html">ModCluster_Internals</a></p>
</li>
<li>
<p><a href="node_balancers.html">nodes and balancers</a></p>
</li>
<li>
<p><a href="info_rsp.html">INFO-RSP description</a></p>
</li>
<li>
<p><a href="as_integration.html">AS Integration</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>JBossWeb listener:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="cluster_listener.html">ClusterListener</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ModCluster project home page:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://www.modcluster.io/">mod_cluster</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Future directions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="jbc_data_partitioning.html">JBC data partitioning and mod_cluster</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Initial document is derived from discussions held in Neuchatel on December 6,
2007. Participants were Bela Ban, Frederic-Clere, Jason Greene, Sacha Labourey,
Mircea Markus, Remy Maucherat, Brian Stansberry, Manik Surtani, Mladen Turk,
Jimmy Wilson and Galder Zamarreno.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_key_design_goals">Key Design Goals</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Dynamic registration of AS instances and context mountings; no need to
statically configure the JBossWeb "workers" or context mountings on
the Apache httpd side.</p>
</li>
<li>
<p>Cluster-wide load balance calculations maintained on the AS side, with
appropriate load factors sent to the httpd side as circumstances change.</p>
<div class="ulist">
<ul>
<li>
<p>Pluggable policies for calculating the load balance factors.</p>
</li>
</ul>
</div>
</li>
<li>
<p>AS instances send lifecycle notifications to the httpd side, equivalent to
the "disable('D')" and "stop ('S')" values available with mod_proxy Parameter
definition (See
<a href="http://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypass" class="bare">http://httpd.apache.org/docs/2.4/mod/mod_proxy.html#proxypass</a>).</p>
<div class="ulist">
<ul>
<li>
<p>More fine-grained; individual contexts can be disabled/stopped, not just
entire server instances.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_basic_architecture">Basic Architecture</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A new Apache module, "mod_cluster" will be created, based on the existing
mod_proxy module. See JBNATIVE-53 for details.</p>
</div>
<div class="paragraph">
<p>Normal web request traffic will be sent from mod_cluster to the JBossWeb
instances' AJP connector using the AJP protocol. No changes to the AJP protocol
are necessary.</p>
</div>
<div class="paragraph">
<p>On the AS side, a new ModClusterService will be created. It will send cluster
configuration and load balance weighting information to the httpd side via
HTTP/HTTPS.</p>
</div>
<div class="paragraph">
<p>The ModClusterService will be made aware of how to contact the httpd side via
static configuration; there will be no dynamic discovery of httpd instances.
(The list of httpd instances could, however, be changed at runtime via a
management tool.)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modes">Modes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We discussed two possible modes in which the ModClusterService could operate:</p>
</div>
<div class="sect2">
<h3 id="_non_clustered_as_instances">"Non-Clustered" AS instances</h3>
<div class="paragraph">
<p>Here the AS instances do not exchange information amongst themselves. Think in
terms of a group of AS instances running the "default" config, with no JGroups
channel open.</p>
</div>
<div class="paragraph">
<p>In this mode, each AS instance directly communicates with each server on the
Apache httpd side. The ModClusterService would be able to send messages to the
httpd side regarding:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Registration and configuration information</p>
</li>
<li>
<p>Mounting information</p>
</li>
<li>
<p>Lifecycle events (disable/stop the instance or one of its contexts)</p>
</li>
<li>
<p>However, any load balance factor sent from the AS instances would be a static
configuration value, equivalent to the worker.xxx.lbfactor in a mod_jk
workers.properties file</p>
<div class="ulist">
<ul>
<li>
<p>Minor "nice-to-have" is the ability for the load balance factor to be
updated at runtime (e.g. via a management tool) with the new value passed
to the httpd side.</p>
</li>
<li>
<p>A related "nice-to-have" is the ability for a node to update it&#8217;s load
balance factor itself. For example, if the node feels it is overloaded,
it can reduce it&#8217;s factor.  If all nodes did that simultaneously, it
would have no effect, which is OK.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="non-clustered-config.png" alt="non clustered config">
</div>
</div>
<div class="paragraph">
<p><strong>Question:</strong> <em>In this mode, can mod_cluster still make load balance decisions
a la the mod_jk Request, Session and Traffic methods? Or would the load balance
factor from the static configuration be the sole factor in the load balance
decision?</em></p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong>  The load balance factor would be the sole factor in the decision;
don&#8217;t want to maintain load balance policy code in mod_cluster. See above
"nice-to-have" on allowing each node to dynamically update its load balance
factor to reflect its own appraisal of its status.</p>
</div>
</div>
<div class="sect2">
<h3 id="_clustered_as_instances">"Clustered" AS instances</h3>
<div class="paragraph">
<p>The AS instances would form a cluster (using JGroups) and could thus exchange
various metrics that would be used in the load balance factor calculation.
ModClusterService would include an HASingleton component such that one member
of the cluster would be responsible for collating these metrics, deriving the
load balance factor for all group members, and sending that consolidated
information to each server on the Apache httpd side.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="clustered-config.png" alt="clustered config">
</div>
</div>
<div class="paragraph">
<p><strong>Question:</strong> <em>In this mode, would messages other than load balance factors be
transmitted via the HASingleon member? My (BES) initial take on this is it
seems simpler to restrict the HASingleton messages to load balance
information.</em></p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> That is probably enough. But it could interesting to see if a node
of the cluster could "ping" htttpd.</p>
</div>
</div>
<div class="sect2">
<h3 id="_normal_request_handling">Normal Request Handling</h3>
<div class="paragraph">
<p>Normal request traffic is passed from mod_cluster to the AJP connector in the
normal, fashion; i.e. via AJP over a pool of long-lasting connections.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="request-handling.png" alt="request handling">
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_as_zo_mod_cluster_communications_modcluster_managment_protocol_mcmp">AS zo mod_cluster Communications – ModCluster Managment Protocol (MCMP)</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The specification of the communication protocol between the ModClusterService
and httpd is the main detail area that needs to be hammered out between the AS
clustering team and the mod_cluster side. Once that is done each side can
proceed fairly independently.</p>
</div>
<div class="paragraph">
<p>Communication from ModClusterService to httpd will be done via HTTP or HTTPS.
There is ongoing discussion of what HTTP method is most appropriate. GET can be
fairly human-readable and is easiest to use via a CLI (e.g. telnet). But, GET
requests are limited by the 8 Kbytes4 bytes URL length limitation, and even it
is unlikely that some requests would need to go beyond that length, POST seems
like a reasonable choice and there is currently discussion of using a
WebDAV-like approach where we define custom request types (corresponding to the
message types below). It is not easy to pass parameter values as HTTP headers
rather because httpd logic will optimize them (app: /myapp is transform while
parsing into app: /myapp, /hisapp).</p>
</div>
<div class="paragraph">
<p>This communication would be over the regular port that httpd is listening on,
with the request being internally handled by mod_cluster_manager based on a
special context path mount in httpd.conf. Basically, something like
<code>SetHandler mod-cluster</code>. What port to use depends on how httpd is configured.</p>
</div>
<div class="paragraph">
<p><strong>Issue:</strong> <em>Securing this mount is a bit trickier than the jkstatus case,
which could often just be set to only "Allow from: 127.0.0.1". Such a simple
approach won&#8217;t work here as a large number of AS instances will need to be able
to communicate.</em></p>
</div>
<div class="paragraph">
<p><strong>Solution:</strong> It is possible to have the SetHandler directive in a VirtualHost
where SSL is mandatory.</p>
</div>
<div class="paragraph">
<p>Example of Secure SetHandler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>Listen 9443
&lt;VirtualHost _default_:9443&gt;
SSLEngine on
SSLCipherSuite ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP:+eNULL
SSLCertificateFile conf/server.crt
SSLCertificateKeyFile conf/server.key
SSLCACertificateFile conf/server-ca.crt
SSLVerifyClient require
SSLVerifyDepth  10
SetHandler mod-cluster
&lt;/VirtualHost&gt;</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_basic_categories_of_messages">Basic categories of messages:</h3>
<div class="sect3">
<h4 id="_configuration_information">Configuration Information</h4>
<div class="paragraph">
<p>Per node.  Initially provided by each node (or perhaps by the HASingleton)
during the startup process for the node.</p>
</div>
<div class="paragraph">
<p>The "Connection Directives" and "Advanced Worker Directives" sections of the
<a href="http://tomcat.apache.org/connectors-doc/reference/workers.html">Apache Tomcat
Connector - Reference Guide</a> give a good description of the various options
supported by mod_jk.</p>
</div>
<div class="paragraph">
<p><strong>Question/TODO:</strong> <em>Which if any of these are not available, given that the
code base is mod_proxy not mod_jk?</em></p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> See <a href="node_conf.html">this</a> for a proposal
for that stuff.</p>
</div>
<div class="paragraph">
<p>Other configuration items mentioned in the Neuchatel discussions that are
notdirectly mentioned in the reference guide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Authentication information (not sure what was meant here)</p>
</li>
<li>
<p>Max sessions</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>Question:</strong> <em>My assumption is we&#8217;ll support updating these values after the
initial registration of a worker.</em></p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> Those value will be stored in shared memory and should be used
while processing new connections and new requests.</p>
</div>
</div>
<div class="sect3">
<h4 id="_load_balancing_factors">Load Balancing Factors</h4>
<div class="paragraph">
<p>Either a single load balance factor (in "non-clustered" mode) or a set of
factors (in "clustered" mode).</p>
</div>
</div>
<div class="sect3">
<h4 id="_general_load_balancing_configurations">General Load Balancing Configurations</h4>
<div class="paragraph">
<p>Things like the mod_jk 'sticky-session' and 'sticky-session-force' directives.
See the "Load Balancing Directives section in the
<a href="http://tomcat.apache.org/connectors-doc/reference/workers.html">Apache Tomcat
Connector - Reference Guide</a> for others.</p>
</div>
<div class="paragraph">
<p><strong>Issue:</strong> <em>If the ModClusterService is operating in "non-clustered" mode, it
isn&#8217;t clear who configures these.</em></p>
</div>
<div class="paragraph">
<p><strong>Answer:</strong> In "non-clustered" mode, each AS instance will independently send
this information, with any new data overriding the older. It is the
responsibility of the user to ensure that each AS instance has the same
configuration for these global values.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_management_message_types">Management Message Types</h3>
<div class="paragraph">
<p>Requests from ModClusterService notify the httpd side of lifecycle events:
startup/shutdown of JBossWeb instances; deploy/undeploy of webapps.</p>
</div>
<div class="paragraph">
<p>Requests are sent via HTTP/HTTPS (80, 443); the exact HTTP request method is a
subject of ongoing discussion.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>CONFIG:</strong> Send configuration information for a node or set of nodes.</p>
</li>
<li>
<p><strong>ENABLE-APP:</strong> Send requests and assign new sessions to the specified app.
Use of  to identify the app means enable all apps on the given node.</p>
</li>
<li>
<p><strong>DISABLE-APP:</strong> Apache should not create new session for this webapp, but
still continue serving existing session on this node. Use of  to identify the
app means disable all apps on the given node.</p>
</li>
<li>
<p><strong>STOP-APP:</strong> New requests for this webapp should not be sent to this node.
Use of to identify the app means stop all apps on the given node.</p>
</li>
<li>
<p><strong>REMOVE-APP:</strong> No requests for this webapp should be sent to this node. Use
of to identify the app means the node has been removed from the cluster. In
this case all other configuration information for the node will be removed and
any open connection between httpd and the node will be closed.</p>
</li>
<li>
<p><strong>STATUS:</strong> Send the current load balance factor for this node (or a set of
nodes). Periodically sent. mod_cluster_manager responds with a <strong>STATUS-RSP</strong>.
Interesting suggestion is to support sending a different load balance factor
per webapp.</p>
</li>
<li>
<p><strong>INFO:</strong> Request configuration info from mod_cluster_manager. Response would
include information on what virtual hosts are configured (so per-webapp
commands can specify the correct virtual host) and other info that
ModClusterService can make available to management tools (e.g. what
addresses/ports httpd is listening on.) mod_cluster_manager responds with a
<strong>INFO-RSP</strong> message.</p>
</li>
<li>
<p><strong>DUMP:</strong> Request a text dump of the current configuration seen by
mod_cluster_manager. mod_cluster_manager responds with a <strong>DUMP-RSP</strong>
containing a raw ascii text corresponding to the current configuration.</p>
</li>
<li>
<p><strong>PING:</strong> Request check the availability of a httpd or a cluster nodes from
httpd (using the node name (JVMRoute or Scheme, Host and Port).
mod_cluster_manager will respond with a PING-RSP which have a similar format to
<strong>STATUS-RSP</strong>. (Since version 0.0.1 of the protocol).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Previous iteration also had <strong>ENABLE</strong>/<strong>DISABLE</strong>/<strong>STOP</strong> commands that
applied to all apps on a node.  This usage can be handled by passing '' as the
webapp name. A STOP message may still be useful as a signal to
mod_cluster_manager to completely remove all configuration information for a
node from memory. Perhaps a different name than <strong>STOP</strong>, e.g. <strong>REMOVE</strong>.</p>
</div>
<div class="paragraph">
<p>A detailed protocol proposal could be found in
<a href="management_protocol.html">Mod-Cluster_Management_Protocol</a>.</p>
</div>
<div class="paragraph">
<p>Responses to the above requests will contain something like:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"HTTP/1.1 200 OK" When command has been processed correctly.</p>
</li>
<li>
<p>"HTTP/1.1 500 VERSION 1.2.3" if something about the request was not
understood. Version number helping the ModClusterService understand how to
tailor future requests.</p>
</li>
<li>
<p>"HTTP/1.1 200 OK" and the response for the request (for STATUS and DUMP
requests at least).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It could interesting to have the following for some requests:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>List any any exclusion nodes (nodes that mod_cluster regards as failed due to
problems responding to requests)</p>
</li>
<li>
<p>Metrics (open connections, number of retries, etc) that ModClusterService may
wish to use in load balancing calculations.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_virtual_hosts">Virtual Hosts</h3>
<div class="paragraph">
<p>Messages pertaining to particular webapps will need to qualify the webapp&#8217;s
context name with virtual host information.  This virtual host information
needs to be in terms httpd can understand rather than in the terms JBossWeb
uses. E.g., if httpd has a virtual host labs.jboss.org and JBossWeb has a
<code>server.xml</code> host element named "labs", the communication to
mod_cluster_manager must qualify the relevant webapps with "labs.jboss.org".</p>
</div>
<div class="paragraph">
<p>The purpose of the INFO message is to acquire the necessary information to
understand the virtual hosts on the httpd side.  ModClusterService will need
to analyze the names and aliases of the Host instances running in JBossWeb and
correlate them to the appropriate httpd virtual hosts.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_modclusterservice_design">ModClusterService Design</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The ModClusterService will be based on a modular architecture, with as many
points as possible pluggable and extendable. Major components include:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A pluggable adapter for interfacing with the mod_cluster_manager. The details
of the interaction (POST vs GET vs WebDAV like commands, even whether
mod_cluster_manager is the load balancer) should be completely abstracted away
from the rest of the service.</p>
</li>
<li>
<p>Group communication module for coordinating gathering of metrics, managing
the HASingleton, etc.</p>
</li>
<li>
<p>Metrics gathering module, for gathering needed metrics from the local node.
Likely will include pluggable submodules for interfacing with various AS
subsystems (e.g. JBossWeb for web tier usage statistics, transaction subsystem,
general core server metrics like CPU and memory usage, etc.).</p>
</li>
<li>
<p>Load balancing manager for coordination of metrics gathering.</p>
</li>
<li>
<p>Load balance policy which calculates the current load balance factors.</p>
</li>
<li>
<p>Configuration module for determining information about the runtime
environment, e.g. what port the AJP connector is listening on, what Tomcat Host
instances are running, etc. Perhaps this module will read a configuration file
for other ModClusterService-specific static information, although my general
preference would be to configure that sort of thing via -beans.xml property
injection.</p>
</li>
<li>
<p>Management module for exposing an interface to external management tools.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_clustering_issues">Clustering Issues</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_domains">Domains</h3>
<div class="paragraph">
<p>We want full support for domains.</p>
</div>
<div class="paragraph">
<p>A domain is a way to group nodes that share sessions.</p>
</div>
<div class="paragraph">
<p>However, there are a couple different ways users might implement these; we need
to think through how to handle both. In both cases a JGroups channel is used
for session replication, with group membership limited to the members of the
domain. The question is how the JGroups channel used for intra-cluster
ModClusterService traffic is set up:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The channel includes all members.  In this case, there is one HASingleton
which manages things for all domains.</p>
</li>
<li>
<p>There is a channel per domain, in which case there are multiple HASingleton
instances, one per domain.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The former seems pretty simple, and can generate more accurate load balancing
factors, but the latter is probably preferable for users to configure. To
support the latter, we need to ensure the message protocol doesn&#8217;t result in
messages from one domain accidentally affecting another domain. For example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An HASingleton sends a CONFIG message with data for a set of nodes.
mod_cluster_manager should not treat the absence of a particular node from the
message as meaning that node should be dropped from memory.  Rather, once a
node is configured it should require a specific message to remove it.</p>
</li>
<li>
<p>Same thing for load balance factors. If a message is received that says A has
factor 2, that remains A&#8217;s factor until specifically changed. A STATUS message
changing B, C and D&#8217;s factor with no mention of A doesn&#8217;t somehow set A to 0.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_split_brain_syndrome">Split-Brain Syndrome</h3>
<div class="paragraph">
<p>Problem here is if there is a network partition disrupting intra-cluster
JGroups traffic. Assume traffic between the httpd boxes and the AS instances is
unaffected.  This will result in a situation where more than one HASingleton
will be running, with each feeling the nodes in the other subcluster have died.
We need to avoid a situation where each HASingleton tells mod_cluster_manager
to stop sending traffic to the other subcluster&#8217;s nodes, with the effect that
no nodes are available.</p>
</div>
<div class="paragraph">
<p>Perhaps the way to deal with this is by having the HASingleton send a STATUS or
some other message to mod_cluster_manager before handling what it sees as a
node failure. If mod_cluster_manager regards the node as still being healthy,
the singleton can regard this as a sign of a split-brain condition and defer
telling mod_cluster_manager to remove the node.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_use_cases">Use cases</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>JBoss AS is started</p>
<div class="ulist">
<ul>
<li>
<p>Send CONFIG message to httpd, httpd adds information to internal tables, but
does not yet connect to JBoss via AJP</p>
</li>
<li>
<p>CONFIG contains</p>
<div class="ulist">
<ul>
<li>
<p>Contents of workers.properties: IP address and port of JBoss</p>
</li>
<li>
<p><code>uriworkermap.properties</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Changes to JBoss config are also sent via CONFIG, overwrites the existing
entry at httpd</p>
</li>
<li>
<p>Apache does not yet connect</p>
</li>
<li>
<p>Send ENABLE-APP (with list of all deployed webapps) to httpd</p>
<div class="ulist">
<ul>
<li>
<p>This would happen at the end of the startup phase, after the JBossWeb
connectors are started. Need an internal notification to know when the
connectors are started.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Webapp is deployed on a started JBoss AS</p>
<div class="ulist">
<ul>
<li>
<p>Send ENABLE-APP to Apache</p>
</li>
<li>
<p>Apache adds webapp to its table and forwards requests to one of the JBoss
instances which host this webapp</p>
</li>
<li>
<p>Tables need to maintain information about webapps like stopped, started,
enabled, disabled etc</p>
</li>
<li>
<p>If we support different load balance factors per webapp, a CONFIG message
with the initial factor would need to be sent before the ENABLE-APP</p>
</li>
</ul>
</div>
</li>
<li>
<p>Webapp is undeployed</p>
<div class="ulist">
<ul>
<li>
<p>(Possibly) send DISABLE-APP to Apache, Apache disables the app in its tables:</p>
<div class="ulist">
<ul>
<li>
<p>Requests with existing sessions are still sent to the node</p>
</li>
<li>
<p>Maybe wait until all sessions are drained</p>
<div class="ulist">
<ul>
<li>
<p>More sophisticated things can be done as well, such as waiting until
no requests have come in within a configurable or dynamically determined period
of time (e.g. 15 secs). Idea is to allow the webapp to be stopped on the node
as soon as it is reasonable to assume any previous requests' session state has
been replicated.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Send STOP-APP to Apache</p>
</li>
<li>
<p>Apache removes webapp from its tables</p>
</li>
</ul>
</div>
</li>
<li>
<p>JBoss is stopped (gracefully)</p>
<div class="ulist">
<ul>
<li>
<p>(Possibly) send DISABLE-APP with a '' parameter to Apache, Apache disables
all apps for the node in its tables</p>
<div class="ulist">
<ul>
<li>
<p>Requests with existing sessions are still sent to the node</p>
</li>
<li>
<p>Maybe wait until all sessions are drained</p>
<div class="ulist">
<ul>
<li>
<p>More sophisticated things can be done as well, such as waiting
until no requests have come in within a configurable or dynamically determined
period of time (e.g. 15 secs). Idea is to allow the webapp to be stopped on the
node as soon as it is reasonable to assume any previous requests' session state
has been replicated.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Send STOP-APP with a '' parameter to Apache, Apache stops all apps for the
node in its tables</p>
</li>
<li>
<p><strong>Issue:</strong> The above causes mod_cluster to stop routing requests to the node,
but it still maintains all configuration information for the node in memory.
Perhaps an additional <strong>STOP</strong> or <strong>REMOVE</strong> command is needed to signal
mod_cluster to remove all configuration information.</p>
</li>
</ul>
</div>
</li>
<li>
<p>JBoss sends load (STATUS) information to Apache</p>
<div class="ulist">
<ul>
<li>
<p>Sent regularly, in configurable intervals.</p>
</li>
<li>
<p>Either single or clustered: multiple or one value, e.g. for multiple: A:1, B:4, C:2, D:4. Same as load balance type 'R' currently</p>
</li>
<li>
<p>Response is used to get info from httpd</p>
<div class="ulist">
<ul>
<li>
<p>workers mod_cluster sees as being in error state</p>
<div class="ulist">
<ul>
<li>
<p>If ModClusterService doesn&#8217;t believe a listed worker has failed, it
can send messages to mod_cluster telling it to try to recover the worker
(see below).</p>
</li>
</ul>
</div>
</li>
<li>
<p>any httpd-side metrics being tracked by the AS for management or load
balancing purposes</p>
</li>
</ul>
</div>
</li>
<li>
<p>If in non-clustered mode and we don&#8217;t send dynamic load information, we can
also simply not send this message</p>
<div class="ulist">
<ul>
<li>
<p><strong>Issue:</strong> If we don&#8217;t send a STATUS message and mod_cluster regards a
node as being in error state, the node will never know that and will never try
to recover itself. As a solution 1) we could have each node periodically send a
STATUS to avoid this, or 2) perhaps mod_cluster could do what mod_jk does, and
run a background thread that tries to resurrect nodes in error state.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>JBoss crashes</p>
<div class="ulist">
<ul>
<li>
<p>Two possible mechanisms for detecting the problem:</p>
<div class="ulist">
<ul>
<li>
<p>If clustered, the HA Singleton may detect the crashed node via the
JGroups failure detection protocols.</p>
</li>
<li>
<p>Whether the JBoss AS nodes are clustered or not, mod_cluster may detect
the failed node before JGroups does (e.g. via CPING/CPONG). mod_cluster marks
the worker as being in error state.</p>
<div class="ulist">
<ul>
<li>
<p>In clustered mode, in the response to its next STATUS request the HA
Singleton will be made aware of the fact that mod_cluster sees the node as
failed</p>
</li>
<li>
<p>If ModClusterService still doesn&#8217;t see the node as failed (i.e.,
JGroups FD/VERIFY_SUSPECT timeouts have not elapsed), it will send another
CONFIG and set the node status to UP to mod_cluster_manager</p>
</li>
<li>
<p>mod_cluster will attempt to use the node again, and will fail</p>
</li>
<li>
<p>process repeats until JGroups detects the node failure</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>No matter which of the above paths is followed, once ModClusterService
regards the node as failed it sends STOP-APP with a '' parameter to Apache,
Apache stops all apps for the node in its tables</p>
</li>
<li>
<p>As in 4 above, we need a mechanism for telling Apache to remove the worker
config from memory</p>
</li>
<li>
<p>When the JBoss instance comes back up, it&#8217;ll go through use case 1: a CONFIG
message is sent which adds the nodes configuration, then ENABLE-APP to signal
that requests can be sent.</p>
</li>
</ul>
</div>
</li>
<li>
<p>JBoss instance hangs</p>
<div class="ulist">
<ul>
<li>
<p>Very similar to 5 above, only difference is it is possible the node will
recover before JGroups removes it from the group.</p>
</li>
<li>
<p>Either way, when instance has rejoined the cluster, we will need to send
another CONFIG to Apache, so Apache adds the JBoss instance to its tables</p>
</li>
</ul>
</div>
</li>
<li>
<p>Connectivity is lost between mod_cluster and a node (non-clustered case)</p>
<div class="ulist">
<ul>
<li>
<p>This is conceptually similar to 7 above.  mod_cluster cannot successfully
connect to an AS instance, so it adds it to its error table.</p>
</li>
<li>
<p>If we decide that the non-clustered nodes will periodically send STATUS
messages, the node will learn it is in the error list and try to recover itself
(new CONFIG + ENABLE-APP)</p>
</li>
<li>
<p>Otherwise, a background process on the httpd side will need to periodically
try to recover the node</p>
</li>
</ul>
</div>
</li>
<li>
<p>Connectivity is lost between mod_cluster and a node (clustered case, node is
not HASingleton)</p>
<div class="ulist">
<ul>
<li>
<p>Similar to 8 above. Here the HASingleton will for sure periodically send
STATUS messages and will send a new CONFIG + ENABLE-APP to try to recover the
node.</p>
</li>
<li>
<p><strong>Remark:</strong> <em>Without an asynchronous ping/pong this will cause QoS problems:
The node will be marked UP and mod_cluster will forward new requests to it if
the connectivity between mod_cluster and the node is still lost all those
requests will timeout on connect and fall back to another node. See
<a href="ping_pong.html">this document</a>.</em></p>
</li>
</ul>
</div>
</li>
<li>
<p>Connectivity is lost between mod_cluster and a node (node is the
HASingleton)</p>
<div class="ulist">
<ul>
<li>
<p>Tricky situation, as the singleton is basically non-functional if it cannot
talk to the httpd side.  This will need to be handled with an extension to the
normal HASingleton handling whereby a master can force an election of a new
singleton master if it detects it cannot contact httpd, with the election
policy ensuring the problem node is not elected.</p>
<div class="ulist">
<ul>
<li>
<p>This perhaps can be done by storing a Boolean in the DRM for each node
(rather than the usual meaningless String). The boolean indicates whether the
node can send to mod_cluster_manager; election policy excludes nodes with
'false'. Node updates the DRM with a boolean 'false' when it detects a problem;
this update should trigger a new election.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Perhaps we need a PING message that each node can use to check its ability to
send to mod_cluster_manager?</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_misc">Misc</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>All requests to apache are sent to the apache default port (80), or whichever
port is configured</p>
</li>
<li>
<p>There&#8217;s a dummy app (like 'status') which processes those requests (provided
by mod-cluster-manager)</p>
</li>
<li>
<p>The AJP configuration can be completely set with a CONFIG message from the
JBoss side</p>
</li>
<li>
<p>Anything that can be configured via the existing mod_jk 'status' webapp can
be configured via MCMP</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_other_considerations">Other Considerations</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>It would be nice the an implementation of the ModClusterService could be
deployed in AS 4.x.</p>
<div class="ulist">
<ul>
<li>
<p>Any code that interacts with JBossWeb to gather metrics would need to be
pluggable to support any interface differences.</p>
</li>
<li>
<p>JGroups or HAPartition usage could be different, as could HASingleton
usage.</p>
</li>
<li>
<p>So, a "nice-to-have".</p>
</li>
</ul>
</div>
</li>
<li>
<p>Where should the code live.  Who will use it (see issue above), what will the
dependencies be, etc.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-05-07 10:13:46 UTC
</div>
</div>
</body>
</html>